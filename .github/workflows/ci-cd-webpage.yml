# ------------------------------------------------------------
# Workflow name (shown in the GitHub Actions UI)
# ------------------------------------------------------------
name: CI/CD Webpage Workflow

# ------------------------------------------------------------
# Events that trigger the workflow
# ------------------------------------------------------------
on:
  push:
    branches:
      - main # Run the workflow whenever code is pushed to main

# ------------------------------------------------------------
# Jobs in this workflow
# ------------------------------------------------------------
jobs:
  # ==========================================================
  # Job 1: Build and Test
  # ==========================================================
  build_and_test:
    runs-on: ubuntu-latest # Use the latest Ubuntu runner

    permissions:
      contents: read
      issues: write

    steps:
      # ------------------------------------------------------
      # Step 1: Checkout the repository code
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------
      # Step 2: Set up Python
      # ------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x" # Always uses the latest Python 3

      # ------------------------------------------------------
      # Step 3: Install dependencies
      # ------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      # ------------------------------------------------------
      # Step 4: Run unit tests
      # ------------------------------------------------------
      - name: Run unit tests
        run: |
          python -m unittest discover tests

      # ------------------------------------------------------
      # Step 5: Notify developer if the workflow fails
      # ------------------------------------------------------
      - name: Notify developer on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "‚ùå CI/CD Pipeline Failed",
              body: `
              The CI/CD workflow failed.

              **Commit:** ${context.sha}
              **Branch:** ${context.ref}
              **Workflow:** ${context.workflow}

              Please check the GitHub Actions logs.
              `
            });

  # ==========================================================
  # Job 2: Deploy to GitHub Pages
  # ==========================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test # Only runs if build_and_test succeeds

    # --------------------------------------------------------
    # Required permissions for GitHub Pages deployment
    # --------------------------------------------------------
    permissions:
      contents: read
      pages: write
      id-token: write

    # --------------------------------------------------------
    # Associate this job with the GitHub Pages environment
    # --------------------------------------------------------
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # ------------------------------------------------------
      # Step 1: Checkout the repository
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------
      # Step 2: Configure GitHub Pages
      # ------------------------------------------------------
      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      # ------------------------------------------------------
      # Step 3: Upload website files as an artifact
      # ------------------------------------------------------
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: . # Publish the root directory (index.html)

      # ------------------------------------------------------
      # Step 4: Deploy the site to GitHub Pages
      # ------------------------------------------------------
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
